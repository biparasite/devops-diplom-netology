- name: Install Cilium CNI
  become: false
  block:
    - name: Add Cilium Helm repository
      ansible.builtin.command:
        cmd: helm repo add cilium https://helm.cilium.io
      changed_when: false
    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
      changed_when: false
    - name: Install Cilium via Helm
      kubernetes.core.helm:
        name: cilium
        chart_ref: cilium/cilium
        namespace: kube-system
        values:
          kubeProxyReplacement: true
          k8sServiceHost: "{{ ansible_default_ipv4.address }}"
          k8sServicePort: 6443
          cni:
            enabled: true
          operator:
            enabled: true
      register: cilium_install_result
    - name: Debug Helm output
      ansible.builtin.debug:
        var: cilium_install_result
      when: cilium_install_result is failed

    - name: Pause until user confirmation
      ansible.builtin.pause:
        prompt: "Verify application updates and press 'C' to continue or 'A' to abort."

    - name: Add stable chart repo prometheus-community
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: "https://prometheus-community.github.io/helm-charts"
    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
    - name: Deploy latest version of prometheus-community
      kubernetes.core.helm:
        name: my-prometheus-stack
        chart_ref: prometheus-community/kube-prometheus-stack
        release_namespace: monitoring
        create_namespace: true
        update_repo_cache: true

    - name: Add stable chart repo ArgoCD
      kubernetes.core.helm_repository:
        name: argo
        repo_url: "https://argoproj.github.io/argo-helm"
    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
    - name: Deploy latest version of argocd
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        release_namespace: argocd
        create_namespace: true
        update_repo_cache: true

    - name: Add stable chart repo prometheus-community
      kubernetes.core.helm_repository:
        name: jenkins
        repo_url: "https://charts.jenkins.io"
    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
    - name: Deploy latest version of jenkins
      kubernetes.core.helm:
        name: jenkins
        chart_ref: jenkins/jenkins
        release_namespace: jenkins
        create_namespace: true
        update_repo_cache: true
  rescue:
    - name: Обработка ошибки
      ansible.builtin.debug:
        msg: "Что-то пошло не так"
